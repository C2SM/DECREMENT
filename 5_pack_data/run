#!/bin/bash

# clean
./clean

#Check if output folder exists
mkdir -p $(readlink output)

# Load modules
export OMP_NUM_THREADS=$CORES_PER_NODE
export CRAY_CUDA_MPS=1
module load daint-gpu
module load NCO

# Compress, archive and remove originals
for direc in ${LM_COMPRESS_DIRS}; do
    nc_list=$(cosmo_file_list "input/${direc}" "${LM_BEGIN_DATE}" "${LM_END_DATE}")
    if [[ -n ${nc_list} ]]; then
        # compress files
        ./nczip -kv "${nc_list}"
        
        cd input
        # create archive
        if [[ $? == 0 ]]; then
            nz_files=$(find ${direc} -name '*.nz')
            part=$(dirname ${direc})
            stream=$(basename ${direc})
            tar_file="../output/${part}__${stream}__${LM_BEGIN_DATE_DG}-${LM_END_DATE_DG}.tar"
            tar --transform='s/.nz/.nc/' -cvf ${tar_file} ${nz_files}
        fi

        # remove compressed files
        if [[ $? == 0 ]]; then        
            echo "removing compressed files"
            rm ${nz_files}
        fi
        cd ..

        # remove original files
        if [[ $? == 0 ]]; then
            rm -f ${nc_list}
        fi
    else
        echo "no nc files found in ${direc} between ${LM_BEGIN_DATE_FR} and ${LM_END_DATE_FR}"
    fi
done
