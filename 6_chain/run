#!/bin/bash

if [ -z "$1" ]; then
  WAITFORJOB=""
else
  WAITFORJOB="$1"
fi

# cleanup
if [ -f .jobid ]; then
  $(squeue -j `cat .jobid` &>/dev/null) && scancel `cat .jobid`
  sleep 3
  \rm .jobid 2>/dev/null
fi
./clean

cat > job <<EOF_job
#!/bin/bash -l
#
#SBATCH --job-name=chain
#SBATCH --output=job.out
#SBATCH --time=00:05:00
#SBATCH --nodes=1
#SBATCH --partition=normal
#SBATCH --account=${ACCOUNT}

#Check if we are done. If yes, exit
sEndDate=\$(date -d \${LM_END_DATE} +%s)
sFinDate=\$(date -d \${LM_FIN_DATE} +%s)
if [ \$sEndDate -ge \$sFinDate ] ; then
  echo "done"
  exit 0 
fi

export LM_BEGIN_DATE=\${LM_END_DATE}
cd ..
./run_daint.sh
EOF_job

if [ -z "${WAITFORJOB}" ]; then
  jobid=$(sbatch --parsable -C gpu job)
else
  jobid=$(sbatch --parsable -C gpu --dependency=afterok:${WAITFORJOB} job)
fi

if [ $? -eq 0 -a -n "${jobid}" ]; then
  echo "${jobid}" > .jobid
  echo "${jobid}"
else
  exit 1
fi
